---
- name: Bootstrap lab server
  hosts: all
  become: true
  
  tasks:
    - name: Update all packages
      dnf:
        name: "*"
        state: latest
        update_cache: true
    
    - name: Install developer tools
      dnf:
        name:
          - vim
          - git
          - curl
          - wget
          - htop
          - tmux
          - nano
          - tree
        state: present
    
    - name: Set hostname
      hostname:
        name: shadowlands
    
    - name: Set timezone
      timezone:
        name: Australia/Brisbane
    
    - name: Disable root SSH login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
      notify: Restart sshd
    
    - name: Disable password authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
      notify: Restart sshd
    
    - name: Install fail2ban
      dnf:
        name: fail2ban
        state: present
    
    - name: Enable and start fail2ban
      systemd:
        name: fail2ban
        enabled: true
        state: started
  
  handlers:
    - name: Restart sshd
      systemd:
        name: sshd
        state: restarted
