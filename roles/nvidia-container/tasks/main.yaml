---
- name: Add NVIDIA container toolkit repository
  ansible.builtin.get_url:
    url: https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo
    dest: /etc/yum.repos.d/nvidia-container-toolkit.repo
    mode: '0644'

- name: Install NVIDIA container toolkit
  ansible.builtin.dnf:
    name: nvidia-container-toolkit
    state: present

- name: Check if Docker already configured for NVIDIA
  ansible.builtin.shell: grep -q nvidia /etc/docker/daemon.json 2>/dev/null
  register: docker_nvidia_configured
  changed_when: false
  failed_when: false

- name: Configure Docker runtime for NVIDIA
  ansible.builtin.command: nvidia-ctk runtime configure --runtime=docker
  when: docker_nvidia_configured.rc != 0
  notify: Restart Docker
